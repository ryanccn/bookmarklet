#!/usr/bin/env node
import F from"../node_modules/sade/lib/index.js";import{build as g}from"../node_modules/esbuild/lib/main.js";import{bold as b,green as l,cyan as y,dim as n,magenta as x}from"../node_modules/kleur/colors.mjs";import{readFile as f}from"fs/promises";import{join as m}from"path";import{z as e}from"../node_modules/zod/lib/index.mjs";var d=e.object({write:e.union([e.literal(!1),e.string()]).default("bookmarklet.txt"),print:e.boolean().default(!1),copy:e.boolean().default(!0),target:e.optional(e.string())}),s=async()=>{let t;try{let r=await f(m(process.cwd(),".bookmarklet.json"),{encoding:"utf-8"});t=JSON.parse(r)}catch{t={}}let o=d.safeParse(t);if(!o.success)throw new Error(o.error.message);return o.data};import{red as w}from"../node_modules/kleur/colors.mjs";import{execa as u}from"../node_modules/execa/index.js";var c=async t=>{let o=await u("pbcopy",{input:t});o.exitCode!==0&&(console.error(w(`\`pbcopy\` exited with code ${o.exitCode}`)),process.exit(1))};import{readFile as k,writeFile as C}from"fs/promises";var p=async t=>{let o=await s(),r=performance.now(),a=await g({entryPoints:[t],bundle:!0,minify:!0,format:"iife",platform:"browser",target:o.target??"chrome96",...o.write?{outfile:o.write,write:!0}:{write:!1}});if(console.log("Built in "+b(l(`${(performance.now()-r).toFixed(2)}ms`))),!o.write&&!a.outputFiles)throw new Error;let i="javascript:"+(o.write?await k(o.write,{encoding:"utf8"}):(a.outputFiles??[{text:""}])[0].text).trim();o.write&&(await C(o.write,i),console.log("Wrote to "+x(o.write))),(o.print||o.copy)&&(o.print&&(console.log(),console.log(n("```js")),console.log(y(i)),console.log(n("```"))),o.copy&&(await c(i),!o.print&&!o.write?console.log(l("Copied to clipboard!")):console.log(n("[copied to clipboard]"))))};F("bookmarklet").version("0.0.2").command("build <file>").describe("Build a bookmarklet").action(p).parse(process.argv);
